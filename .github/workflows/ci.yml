name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  build:
    runs-on: [self-hosted, windows]
    environment: Build
    env:
      KSA_GAME_DIR: ${{ vars.KSA_GAME_DIR }}
    permissions:
      contents: read
      packages: read
    steps:
      - name: Disable Git FSMonitor (workaround)
        shell: cmd
        run: |
          git config --global core.usebuiltinfsmonitor false
          git config --global core.fsmonitor false

      - uses: actions/checkout@v4

      - name: Ensure game assemblies are available
        shell: cmd
        run: |
          if exist "Import\KSA.dll" exit /b 0
          if not defined KSA_GAME_DIR echo Import folder missing. Set KSA_GAME_DIR to the folder containing the game's DLLs, e.g. ...\KSA_Data\Managed on the self-hosted runner. & exit /b 1
          if not exist "Import" mkdir "Import"
          copy /Y "%KSA_GAME_DIR%\*.dll" "Import\"


      - name: Restore
        shell: cmd
        run: dotnet restore KittenProtoLink/ProtoLink.sln

      - name: Build (Release)
        shell: cmd
        run: dotnet build KittenProtoLink/ProtoLink.sln -c Release --no-restore
