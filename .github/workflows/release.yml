name: Release

on:
  push:
    tags:
      - 'v*'   # v1.0.0

jobs:
  build:
    runs-on: [self-hosted, windows]
    environment: Build
    env:
      KSA_GAME_DIR: ${{ vars.KSA_GAME_DIR }}

    permissions:
      contents: write
      packages: read

    defaults:
      run:
        shell: cmd

    steps:
      - name: Disable Git FSMonitor (workaround)
        run: |
          git config --global core.usebuiltinfsmonitor false
          git config --global core.fsmonitor false

      - uses: actions/checkout@v4

      - name: Derive version from tag
        run: |
          set "TAG=%GITHUB_REF_NAME%"
          set "VERSION=%TAG:~1%"
          echo VERSION=%VERSION%>> "%GITHUB_ENV%"
          echo ZIP_NAME=kittenprotolink-%TAG%.zip>> "%GITHUB_ENV%"

      - name: Ensure game assemblies are available
        run: |
          if exist "Import\KSA.dll" exit /b 0
          if not defined KSA_GAME_DIR echo Import folder missing. Set KSA_GAME_DIR to the folder containing the game's DLLs, e.g. ...\KSA_Data\Managed on the self-hosted runner. & exit /b 1
          if not exist "Import" mkdir "Import"
          copy /Y "%KSA_GAME_DIR%\*.dll" "Import\"

      - name: Restore
        run: dotnet restore KittenProtoLink/ProtoLink.sln

      - name: Build (Release) with tag version
        run: |
          dotnet build KittenProtoLink/ProtoLink.sln -c Release --no-restore ^
            /p:Version=%VERSION% ^
            /p:AssemblyVersion=%VERSION% ^
            /p:FileVersion=%VERSION% ^
            /p:InformationalVersion=%VERSION%+%GITHUB_SHA:~0,7%

      - name: Collect artifact payload
        run: |
          set "OUT=KittenProtoLink\KittenProtoLink\bin\Release\net10.0"
          set "PKG=artifacts\kittenprotolink"
          if not exist "%PKG%" mkdir "%PKG%"
          copy /Y "%OUT%\KittenProtoLink.dll" "%PKG%\"
          copy /Y "%OUT%\KittenProtoLink.pdb" "%PKG%\"
          copy /Y "%OUT%\KittenProtoLink.deps.json" "%PKG%\"
          copy /Y "%OUT%\mod.toml" "%PKG%\"
          copy /Y "%OUT%\Thresholds.json" "%PKG%\"
          copy /Y "LICENSE" "%PKG%\"
          if not exist "%PKG%\Example" mkdir "%PKG%\Example"
          copy /Y "telemetry_client.py" "%PKG%\Example\"
          copy /Y "Generated\ksa_controller_pb2.py" "%PKG%\Example\"

      - name: Zip payload (PowerShell via cmd)
        shell: cmd
        run: |
            if exist "artifacts\%ZIP_NAME%" del /F /Q "artifacts\%ZIP_NAME%"
            powershell -NoProfile -ExecutionPolicy Bypass -Command "& { Compress-Archive -Path 'artifacts\kittenprotolink\*' -DestinationPath ('artifacts\%ZIP_NAME%') -Force }"
            powershell -NoProfile -ExecutionPolicy Bypass -Command "& { Add-Type -AssemblyName System.IO.Compression.FileSystem; [IO.Compression.ZipFile]::OpenRead(('artifacts\%ZIP_NAME%')).Entries | Select-Object FullName,Length }"

      - name: Upload artifact (folder)
        uses: actions/upload-artifact@v4
        with:
          name: kittenprotolink-${{ github.ref_name }}
          path: artifacts/kittenprotolink
          if-no-files-found: error

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: artifacts/${{ env.ZIP_NAME }}
